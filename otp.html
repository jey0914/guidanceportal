<?php
session_start();
include("db.php");

// --- Auth guard
if (!isset($_SESSION['parent_email'])) {
    header("Location: parent_login.php");
    exit();
}

$parent_email = $_SESSION['parent_email'];

// --- Get student_id of this parent
$stmt = $con->prepare("SELECT student_id FROM parents WHERE email = ?");
$stmt->bind_param("s", $parent_email);
$stmt->execute();
$res = $stmt->get_result();
if ($res->num_rows === 0) {
    die("No linked student found.");
}
$parent = $res->fetch_assoc();
$student_id = $parent['student_id'];

// --- Get student info
$stmt2 = $con->prepare("SELECT fname, lname, student_no, strand_course, year_level 
                        FROM form WHERE id = ?");
$stmt2->bind_param("i", $student_id);
$stmt2->execute();
$student = $stmt2->get_result()->fetch_assoc();

// --- Get RFID logs (latest first)
// Assume table: rfid_logs(student_id, tag_uid, device, event, scanned_at)
$stmt3 = $con->prepare("SELECT tag_uid, device, event, scanned_at 
                        FROM rfid_logs 
                        WHERE student_id = ? 
                        ORDER BY scanned_at DESC");
$stmt3->bind_param("i", $student_id);
$stmt3->execute();
$logs = $stmt3->get_result();
?>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Parent - RFID Attendance</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body class="bg-dark text-light">
  <div class="container py-4">
    <!-- Header -->
    <div class="d-flex align-items-center mb-4">
      <i class="bi bi-qr-code-scan fs-2 me-2"></i>
      <div>
        <h4 class="mb-0">Attendance Records</h4>
        <small class="text-muted">
          <?php echo htmlspecialchars($student['fname']." ".$student['lname']); ?> · 
          <?php echo htmlspecialchars($student['student_no']); ?> · 
          <?php echo htmlspecialchars($student['strand_course']); ?> - 
          <?php echo htmlspecialchars($student['year_level']); ?>
        </small>
      </div>
    </div>

    <!-- Table -->
    <div class="table-responsive">
      <table class="table table-dark table-striped align-middle">
        <thead>
          <tr>
            <th>Date</th>
            <th>Time</th>
            <th>Device</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          <?php if ($logs->num_rows > 0): ?>
            <?php while ($row = $logs->fetch_assoc()): 
              $dt = new DateTime($row['scanned_at']);
              $date = $dt->format("Y-m-d");
              $time = $dt->format("h:i A");
              $badge = $row['event'] === 'Entry' ? 'success' : 'danger';
            ?>
              <tr>
                <td><?php echo $date; ?></td>
                <td><?php echo $time; ?></td>
                <td><?php echo htmlspecialchars($row['device']); ?></td>
                <td><span class="badge bg-<?php echo $badge; ?>">
                  <?php echo htmlspecialchars($row['event']); ?>
                </span></td>
              </tr>
            <?php endwhile; ?>
          <?php else: ?>
            <tr><td colspan="4" class="text-center text-muted">No attendance records found.</td></tr>
          <?php endif; ?>
        </tbody>
      </table>
    </div>

    <a href="parent_dashboard.php" class="btn btn-outline-light mt-3">
      <i class="bi bi-arrow-left me-1"></i> Back to Dashboard
    </a>
  </div>
</body>
</html>
